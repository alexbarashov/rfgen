# AIS GMSK Deviation Fix

**–î–∞—Ç–∞:** 2025-10-22
**–ö–æ–º–º–∏—Ç:** `23d044a`
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

## –ü—Ä–æ–±–ª–µ–º–∞

–î–µ–≤–∏–∞—Ü–∏—è —á–∞—Å—Ç–æ—Ç—ã –±—ã–ª–∞ **–≤ 100 —Ä–∞–∑ –±–æ–ª—å—à–µ** —Ç—Ä–µ–±—É–µ–º–æ–π:
- ‚ùå **–ò–∑–º–µ—Ä–µ–Ω–Ω–∞—è:** ¬±240 –∫–ì—Ü
- ‚úÖ **–¢—Ä–µ–±—É–µ–º–∞—è:** ¬±2.4 –∫–ì—Ü (ITU-R M.1371)

## –ü—Ä–∏—á–∏–Ω–∞

–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Ñ–∞–∑–æ–≤–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ `_gmsk_modulate_ais()`:

```python
# ‚ùå –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
phase = np.cumsum(np.pi * h * filtered)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ —É—á–∏—Ç—ã–≤–∞–ª–∞—Å—å —á–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ Fs!

## –†–µ—à–µ–Ω–∏–µ

–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å —É—á—ë—Ç–æ–º Fs:

```python
# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û:
deviation_hz = h * rs / 2.0  # –î–ª—è h=0.5, rs=9600 ‚Üí 2400 Hz
phase = np.cumsum(2.0 * np.pi * deviation_hz * filtered / float(fs))
```

### –û–±—ä—è—Å–Ω–µ–Ω–∏–µ

–î–ª—è GMSK –º–æ–¥—É–ª—è—Ü–∏–∏:
1. **–î–µ–≤–∏–∞—Ü–∏—è —á–∞—Å—Ç–æ—Ç—ã:** Œîf = h √ó Rs / 2
   - h = 0.5 (modulation index)
   - Rs = 9600 baud (symbol rate)
   - Œîf = 0.5 √ó 9600 / 2 = **2400 Hz**

2. **–ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞:** f[n] = Œîf √ó filtered[n]
   - filtered[n] –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [-1, +1] –ø–æ—Å–ª–µ –≥–∞—É—Å—Å–æ–≤–∞ —Ñ–∏–ª—å—Ç—Ä–∞

3. **–§–∞–∑–∞:**
   - –î–∏—Å–∫—Ä–µ—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: œÜ[n] = œÜ[n-1] + 2œÄ √ó f[n] / Fs
   - –£–ø—Ä–æ—â–µ–Ω–∏–µ: œÜ[n] = cumsum(2œÄ √ó Œîf √ó filtered / Fs)

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
Instantaneous frequency:
  Max: +240 –∫–ì—Ü
  Min: -240 –∫–ì—Ü
  Deviation: ¬±240 –∫–ì—Ü ‚ùå (–≤ 100 —Ä–∞–∑ –±–æ–ª—å—à–µ!)
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
Instantaneous frequency:
  Max: +2400 Hz
  Min: -2400 Hz
  Deviation: ¬±2400.1 Hz ‚úÖ (–∏–¥–µ–∞–ª—å–Ω–æ!)

Ratio –∫ –æ–∂–∏–¥–∞–µ–º–æ–º—É: 1.000
```

### –î–µ–º–æ–¥—É–ª—è—Ü–∏—è (TesterPi)
```
[DEMOD OK] Found 1 frame(s)
CRC-X25:    True ‚úÖ
Payload:    481d6f345403ff33c8d603412140e10fff844e0006 ‚úÖ
best_eye:   0.015
```

## –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ best_eye

**–ù–∞–±–ª—é–¥–µ–Ω–∏–µ:** `best_eye` —É–º–µ–Ω—å—à–∏–ª—Å—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ–≤–∏–∞—Ü–∏–∏:
- –° –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–µ–≤–∏–∞—Ü–∏–µ–π (240 –∫–ì—Ü): best_eye = 1.527
- –° –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–µ–≤–∏–∞—Ü–∏–µ–π (2.4 –∫–ì—Ü): best_eye = 0.015

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- –î–µ–º–æ–¥—É–ª—è—Ç–æ—Ä TesterPi –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
- –ú–∞–ª–µ–Ω—å–∫–∏–π best_eye –ù–ï –æ–∑–Ω–∞—á–∞–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ CRC –ø—Ä–æ—Ö–æ–¥–∏—Ç
- **–ì–ª–∞–≤–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π:** CRC-X25 –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚úÖ
- –†–µ–∞–ª—å–Ω—ã–µ AIS –ø—Ä–∏—ë–º–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –¥–µ–≤–∏–∞—Ü–∏–µ–π 2.4 –∫–ì—Ü —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É

**–í—ã–≤–æ–¥:** –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–µ–≤–∏–∞—Ü–∏—è (2400 Hz) –≤–∞–∂–Ω–µ–µ –º–µ—Ç—Ä–∏–∫–∏ best_eye.

## –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

–°–æ–≥–ª–∞—Å–Ω–æ **ITU-R M.1371-5** (AIS Technical Characteristics):
- –ú–æ–¥—É–ª—è—Ü–∏—è: GMSK
- Symbol rate: 9600 baud
- BT: 0.4 (–¥–ª—è TX), 0.3-0.5 (–¥–ª—è RX)
- **Modulation index h: 0.5**
- **Frequency deviation: ¬±2400 Hz** (–≤—ã—Ç–µ–∫–∞–µ—Ç –∏–∑ h –∏ Rs)

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏

### –§–æ—Ä–º—É–ª–∞ –¥–µ–≤–∏–∞—Ü–∏–∏ –¥–ª—è MSK/GMSK:
```
Œîf = h √ó Rs / 2

–ì–¥–µ:
- h = 0.5 (modulation index)
- Rs = 9600 baud (symbol rate)

Œîf = 0.5 √ó 9600 / 2 = 2400 Hz ‚úÖ
```

### –°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞:
```
Bandwidth (99%) ‚âà Rs √ó (1 + h) = 9600 √ó 1.5 = 14.4 –∫–ì—Ü

–≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–∞–Ω–∞–ª—É 25 –∫–ì—Ü –¥–ª—è AIS.
```

## –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–£–ª—É—á—à–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å:**
- –†–µ–∞–ª—å–Ω—ã–º–∏ AIS –ø—Ä–∏—ë–º–Ω–∏–∫–∞–º–∏
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏ ITU-R M.1371
- –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–µ–π IEC 61162

‚úÖ **Round-trip —Ç–µ—Å—Ç:**
```
HEX ‚Üí Modulate (2400 Hz deviation) ‚Üí CF32 ‚Üí Demodulate ‚Üí HEX'
Result: HEX == HEX' && CRC_valid == True ‚úÖ
```

## –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

- `rfgen/core/wave_engine.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ñ–æ—Ä–º—É–ª–∞ –≤ `_gmsk_modulate_ais()`

## –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–µ–≤–∏–∞—Ü–∏–µ–π
python test_ais_quick.py

# –î–µ–º–æ–¥—É–ª—è—Ü–∏—è
cd C:\work\TesterPi
python -m beacon406.AIS_cf32_to_HEX captures/iq_960_ais_spec_test.cf32

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
# - CRC-X25: True ‚úÖ
# - Deviation: ~2400 Hz ‚úÖ
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ –î–µ–≤–∏–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞: **2400 Hz** (—Å–æ–≥–ª–∞—Å–Ω–æ ITU-R M.1371)
‚úÖ CRC –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ Round-trip —Ç–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω
‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ AIS —Å–∏—Å—Ç–µ–º–∞–º–∏ —É–ª—É—á—à–µ–Ω–∞

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üì°
