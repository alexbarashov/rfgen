# Задача: Реализация AIS GMSK модулятора

**Дата:** 2025-10-22
**Статус:** ✅ Решено
**Файлы:** `rfgen/core/wave_engine.py`, `rfgen/docs/SPEC/AIS_msg_format.md`

## Проблема

Требовалось реализовать генерацию AIS сигналов согласно спецификации AIS_msg_format.md v1.1:
- GMSK модуляция (h=0.5, BT=0.4, 9600 bps)
- HDLC framing (преамбула + старт-флаг + payload+FCS + стоп-флаг + guard)
- Bit-stuffing (после 5 единиц вставить 0)
- NRZI encoding
- CRC-16/X25 для FCS

## Реализация

Добавлены функции в `wave_engine.py`:

1. **`_crc16_x25_ais(data: bytes) -> int`**
   CRC-16/X25 (poly=0x8408, init=0xFFFF, xorout=0xFFFF)

2. **`_bytes_to_bits_lsb_first_ais(data: bytes) -> np.ndarray`**
   Конвертация байтов в биты (LSB-first)

3. **`_bit_stuff_ais(bits: np.ndarray) -> np.ndarray`**
   HDLC bit-stuffing (только для payload+FCS)

4. **`_nrzi_encode_ais(bits: np.ndarray) -> np.ndarray`**
   NRZI кодирование (бит 0 → переход, бит 1 → без перехода)

5. **`_gaussian_filter_ais(bt: float, sps: int) -> np.ndarray`**
   Gaussian filter для GMSK

6. **`_gmsk_modulate_ais(nrzi_symbols, fs, rs, bt, h) -> np.ndarray`**
   GMSK модуляция

7. **`build_ais(profile: dict) -> np.ndarray`**
   Главная функция генерации AIS IQ-буфера

## Критическая проблема: Частота дискретизации

**Симптомы:**
- При Fs=1024 кГц: CRC-X25: False, ошибки декодирования, HEX не совпадает
- При Fs=960 кГц: CRC-X25: True, идеальное декодирование

**Причина:**
- Fs=1024 кГц → SPS = 1024000/9600 = **106.67** (не целое!)
- Fs=960 кГц → SPS = 960000/9600 = **100** (целое!)

Дробное SPS приводит к накоплению ошибок выборки символов → ошибки CRC и декодирования.

**Решение:**
Fs **ДОЛЖНА БЫТЬ КРАТНА** битрейту 9600 Hz!

Рекомендованные частоты:
- ✅ **960 кГц** (SPS=100) — оптимальная
- ✅ **384 кГц** (SPS=40) — компактная
- ✅ **192 кГц** (SPS=20) — минимальная
- ❌ **НЕ использовать 1024 кГц** (SPS не целое)

## Результаты тестирования

### Эталонный тест (Fs=960 kHz)

**Входной payload:**
```
481d6f345403ff33c8d603412140e10fff844e0006
```

**Результаты демодуляции:**
```
[DEMOD OK] Found 1 frame(s)
Bits:       184
CRC-X25:    True ✅
HEX (full): 481d6f345403ff33c8d603412140e10fff844e0006f3b6
Payload:    481d6f345403ff33c8d603412140e10fff844e0006
best_eye:   1.527 ✅ (открытый глаз)
```

**Вывод:** Полное совпадение с эталоном! CRC валидация пройдена!

## Обновления спецификации

Обновлен `AIS_msg_format.md`:
- Добавлено требование: **Fs ДОЛЖНА БЫТЬ КРАТНА 9600 Hz**
- Обновлены рекомендации по частоте дискретизации
- Добавлены предупреждения о 1024 кГц

## Команды для тестирования

**Генерация IQ:**
```python
from rfgen.core.wave_engine import build_ais

profile = {
    'device': {'fs_tx': 960000},  # Обязательно кратно 9600!
    'pattern': {'hex': '481d6f345403ff33c8d603412140e10fff844e0006'},
    'schedule': {'pre_s': 0.02, 'post_s': 0.02}
}

iq = build_ais(profile)
iq.tofile('iq_960_ais_test.cf32')
```

**Демодуляция (TesterPi):**
```bash
cd C:\work\TesterPi
python -m beacon406.AIS_cf32_to_HEX captures/iq_960_ais_test.cf32
```

## Round-trip тест

```
HEX → Modulate → CF32 → Demodulate → HEX'
✅ HEX == HEX' && CRC_valid == True
```

## Выводы

1. ✅ AIS модулятор реализован согласно спецификации
2. ✅ CRC-16/X25 валидация проходит
3. ✅ HDLC bit-stuffing работает правильно
4. ✅ GMSK модуляция дает открытый eye diagram (best_eye > 1.5)
5. ⚠️ **КРИТИЧНО:** Fs должна быть кратна 9600 Hz!

## Дополнительные исправления

### 1. Проблема: Неправильная девиация
**Симптомы:** Измеренная девиация ±240 кГц (в 100 раз больше!)
**Причина:** Неправильная формула интегрирования фазы
**Исправление:**
```python
# Было (НЕПРАВИЛЬНО):
phase = np.cumsum(np.pi * h * filtered)

# Стало (ПРАВИЛЬНО):
deviation_hz = h * rs / 2.0  # 2400 Hz для h=0.5
phase = np.cumsum(2.0 * np.pi * deviation_hz * filtered / float(fs))
```
**Результат:** ✅ Девиация 2400.1 Hz (точность 1.000)

### 2. Добавлен контроль девиации в UI
**Файл:** `page_ais.py`
**Функционал:**
- QDoubleSpinBox для настройки девиации (100 Hz - 10 kHz)
- Дефолт: 2400 Hz (ITU-R M.1371)
- Автоматический расчёт h = 2×Δf/Rs
- Сохранение в профиль: `standard_params.deviation_hz`

### 3. Исправление импортов
**Проблема:** `ImportError: cannot import name 'resample_iq'`
**Исправлено в:**
- `page_ais.py`
- `page_dsc_hf.py`

```python
# Было:
from ...core.resample import resample_iq

# Стало:
from ...core.resample import resample
```

### 4. Исправление параметра HackRF
**Проблема:** `TypeError: run_loop() got unexpected keyword argument 'pa_enable'`
**Исправлено в:** 5 файлов, 9 вхождений
```python
# Было:
pa_enable=pa_enable

# Стало:
pa_enabled=pa_enable
```

### 5. ⚠️ **КРИТИЧЕСКОЕ:** Исправление пути к IQ файлам
**Проблема:** `'str' object has no attribute 'exists'` при Start Tx
**Причина:** Все UI страницы использовали `profiles_dir()` вместо `out_dir()` для сохранения IQ файлов
**Исправлено в:**
- `page_ais.py`
- `page_121.py`
- `page_406.py`
- `page_dsc_hf.py`
- `page_dsc_vhf.py`
- `page_navtex.py`

```python
# Было (НЕПРАВИЛЬНО):
from ...utils.paths import profiles_dir
default_path = str(profiles_dir() / default_filename)

# Стало (ПРАВИЛЬНО):
from ...utils.paths import out_dir
default_path = str(out_dir() / default_filename)
```
**Результат:** ✅ IQ файлы теперь корректно сохраняются в `rfgen/out/`, профили остаются в `rfgen/profiles/`

## Финальные результаты валидации

**TesterPi демодулятор:**
```
file_path: C:/work/rfgen/rfgen/out/iq_960_ais.cf32
requested_sample_rate_sps: 960000
detected_sample_rate_sps: 960000.0
best_eye: 1.527 ✅
HDLC: found 1 frames ✅
Frame 0:
  bits_before_destuff: 248
  bits_after_destuff: 240
  payload_hex: 481d6f345403ff33c8d603412140e10fff844e00
  CRC-X25: True ✅
```

**Измерение девиации:**
```
Frame Statistics (CPFSK estimator):
  deviation_hz: 2400.1 Hz ✅
  ratio: 1.000 ✅
  confidence: 0.95
```

## Коммиты

- `9731cd4` - Добавлен контроль девиации в UI (0.1-10 кГц)
- `4833500` - Исправлен импорт resample_iq → resample
- `288a3a7` - Исправлен параметр pa_enable → pa_enabled в вызовах HackRF
- `ad44ac1` - ⚠️ Исправлена критическая ошибка пути IQ файлов (profiles_dir → out_dir)

## Следующие шаги

- [x] Обновить UI страницу AIS с дефолтной Fs=960 кГц ✅
- [x] Добавить контроль девиации ✅
- [ ] Добавить валидацию Fs в UI (warning если не кратно 9600)
- [ ] Тестирование на реальном оборудовании (HackRF)
- [ ] Реализовать Message Builder (генерация HEX из MMSI/lat/lon)
