# Задача: Реализация AIS GMSK модулятора

**Дата:** 2025-10-22
**Статус:** ✅ Решено
**Файлы:** `rfgen/core/wave_engine.py`, `rfgen/docs/SPEC/AIS_msg_format.md`

## Проблема

Требовалось реализовать генерацию AIS сигналов согласно спецификации AIS_msg_format.md v1.1:
- GMSK модуляция (h=0.5, BT=0.4, 9600 bps)
- HDLC framing (преамбула + старт-флаг + payload+FCS + стоп-флаг + guard)
- Bit-stuffing (после 5 единиц вставить 0)
- NRZI encoding
- CRC-16/X25 для FCS

## Реализация

Добавлены функции в `wave_engine.py`:

1. **`_crc16_x25_ais(data: bytes) -> int`**
   CRC-16/X25 (poly=0x8408, init=0xFFFF, xorout=0xFFFF)

2. **`_bytes_to_bits_lsb_first_ais(data: bytes) -> np.ndarray`**
   Конвертация байтов в биты (LSB-first)

3. **`_bit_stuff_ais(bits: np.ndarray) -> np.ndarray`**
   HDLC bit-stuffing (только для payload+FCS)

4. **`_nrzi_encode_ais(bits: np.ndarray) -> np.ndarray`**
   NRZI кодирование (бит 0 → переход, бит 1 → без перехода)

5. **`_gaussian_filter_ais(bt: float, sps: int) -> np.ndarray`**
   Gaussian filter для GMSK

6. **`_gmsk_modulate_ais(nrzi_symbols, fs, rs, bt, h) -> np.ndarray`**
   GMSK модуляция

7. **`build_ais(profile: dict) -> np.ndarray`**
   Главная функция генерации AIS IQ-буфера

## Критическая проблема: Частота дискретизации

**Симптомы:**
- При Fs=1024 кГц: CRC-X25: False, ошибки декодирования, HEX не совпадает
- При Fs=960 кГц: CRC-X25: True, идеальное декодирование

**Причина:**
- Fs=1024 кГц → SPS = 1024000/9600 = **106.67** (не целое!)
- Fs=960 кГц → SPS = 960000/9600 = **100** (целое!)

Дробное SPS приводит к накоплению ошибок выборки символов → ошибки CRC и декодирования.

**Решение:**
Fs **ДОЛЖНА БЫТЬ КРАТНА** битрейту 9600 Hz!

Рекомендованные частоты:
- ✅ **960 кГц** (SPS=100) — оптимальная
- ✅ **384 кГц** (SPS=40) — компактная
- ✅ **192 кГц** (SPS=20) — минимальная
- ❌ **НЕ использовать 1024 кГц** (SPS не целое)

## Результаты тестирования

### Эталонный тест (Fs=960 kHz)

**Входной payload:**
```
481d6f345403ff33c8d603412140e10fff844e0006
```

**Результаты демодуляции:**
```
[DEMOD OK] Found 1 frame(s)
Bits:       184
CRC-X25:    True ✅
HEX (full): 481d6f345403ff33c8d603412140e10fff844e0006f3b6
Payload:    481d6f345403ff33c8d603412140e10fff844e0006
best_eye:   1.527 ✅ (открытый глаз)
```

**Вывод:** Полное совпадение с эталоном! CRC валидация пройдена!

## Обновления спецификации

Обновлен `AIS_msg_format.md`:
- Добавлено требование: **Fs ДОЛЖНА БЫТЬ КРАТНА 9600 Hz**
- Обновлены рекомендации по частоте дискретизации
- Добавлены предупреждения о 1024 кГц

## Команды для тестирования

**Генерация IQ:**
```python
from rfgen.core.wave_engine import build_ais

profile = {
    'device': {'fs_tx': 960000},  # Обязательно кратно 9600!
    'pattern': {'hex': '481d6f345403ff33c8d603412140e10fff844e0006'},
    'schedule': {'pre_s': 0.02, 'post_s': 0.02}
}

iq = build_ais(profile)
iq.tofile('iq_960_ais_test.cf32')
```

**Демодуляция (TesterPi):**
```bash
cd C:\work\TesterPi
python -m beacon406.AIS_cf32_to_HEX captures/iq_960_ais_test.cf32
```

## Round-trip тест

```
HEX → Modulate → CF32 → Demodulate → HEX'
✅ HEX == HEX' && CRC_valid == True
```

## Выводы

1. ✅ AIS модулятор реализован согласно спецификации
2. ✅ CRC-16/X25 валидация проходит
3. ✅ HDLC bit-stuffing работает правильно
4. ✅ GMSK модуляция дает открытый eye diagram (best_eye > 1.5)
5. ⚠️ **КРИТИЧНО:** Fs должна быть кратна 9600 Hz!

## Следующие шаги

- [ ] Обновить UI страницу AIS с дефолтной Fs=960 кГц
- [ ] Добавить валидацию Fs в UI (warning если не кратно 9600)
- [ ] Тестирование на реальном оборудовании (HackRF)
