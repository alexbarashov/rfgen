### ТЗ, чтобы убрать «скачки» FM на начале/конце AIS-импульса и сделать стык секций гладким. (Опираюсь на текущую реализацию генератора AIS/GMSK и сборки кадра в `wave_engine.py`.) 

# ТЗ: Гладкие стыки и отсутствие FM-переходов в начале/конце AIS

## Цель

На графике FM (НЧ-детектор частоты) убрать выбросы при:

1. переходе `[pre_noise] → [carrier] → [AIS кадр]` (начало),
2. переходе `[AIS кадр] → [post_noise]` (конец),
   и исключить «звон» гауссова фильтра на краях.

---

## Причины (диагноз)

1. **Краевые эффекты гауссова фильтра** (GMSK) из-за нулевой «подкладки» по краям при свёртке → начальный/конечный артефакт.
2. **Резкие стыки секций**: мгновенная смена статистики сигнала (шум/несущая/модуляция) без кроссфейда.
3. **Неподходящий guard-хвост**: сейчас буфер после стоп-флага — «24 нуля». В NRZI «0» = переход ⇒ на конце кадра получается серия скачков, которые и детектор, и фильтр превращают в импульсы.

---

## Требуемые изменения

### 1) Тёплый запуск/остывание GMSK-фильтра (обяз.)

* **Ввести паддинг символами «единица»** (NRZI=«без переходов») по краям перед свёрткой:

  * `pad_sym = 2 * span_symbols` (минимум 12 символов при span=6).
  * Перед формированием `symbols_up` добавить `pad_sym` единичных символов слева/справа (до апсемплинга или после — эквивалентно, но проще до апсемплинга и затем повторить).
  * Выполнить свёртку `mode='same'` как сейчас.
  * **После свёртки отбросить паддинг** и вернуть длину исходной последовательности.
* Результат: фильтр входит в стационар до преамбулы и спокойно «выходит» после стоп-части — без колебаний на обрезах.

### 2) Правильный guard до и после полезного кадра (обяз.)

* **Перед преамбулой** (сразу после `carrier_ms`) вставить `pre_guard_ones_symbols` (по умолчанию 12–24) **единиц NRZI** — это даёт нулевую мгновенную частоту и прогревает фильтр.
* **Заменить текущий “буфер 24 нуля” после стоп-флага** на `post_guard_ones_symbols` (по умолчанию 24) **единиц NRZI**.
  Обоснование: «1» в NRZI означает **нет перехода** ⇒ конец кадра выходит на «плоскую» частоту 0 Гц без пилы и выбросов.

### 3) Мягкие стыки между секциями (рекомендуемо)

* **Кроссфейд амплитуды** на стыках:

  * Между `pre_noise` → `carrier`: линейный фейд-ин/out длиной `xfade_ms=0.5…1.0 ms`.
  * Между `AIS кадр` → `post_noise`: линейный фейд-аут/ин той же длительности.
* Формула: на интервале `N=xfade_ms*Fs` домножать левую/правую секцию на окно `w[n]` (например, косинус Ханна), а суммарный стык — на `w[n] + (1−w[n])`.
  Это убирает скачок мощности, который НЧ-детектор может интерпретировать как частотный всплеск.

### 4) Непрерывность фазы (контроль)

* **Фаза непрерывна по определению** (комплексная экспонента из интеграла частоты), но:

  * убедиться, что несущая — это ровно `exp(j*φ=0)` (как сейчас), а первый «единичный» guard действительно даёт 0 Гц (постоянную фазу) до преамбулы;
  * на конце после `post_guard_ones_symbols` сделать кроссфейд на шум (п.3), чтобы не было резкой смены статистики.

### 5) Параметры профиля (новые и изменённые)

Добавить в `standard_params` для AIS:

* `pre_guard_ones_symbols` (int, default **12**)
* `post_guard_ones_symbols` (int, default **24**)
* `gmsk_warmup_symbols` (int, default **12**) — внутренний паддинг для свёртки (см. п.1)
* `xfade_ms` (float, default **0.75**) — длительность кроссфейда на стыках
* (оставляем уже добавленные вами):
  `pre_noise_ms`, `carrier_ms`, `post_noise_ms`, `noise_dbfs` — **без изменений поведения**.

### 6) Поведение по умолчанию (регресс-безопасность)

* Если новые параметры **не заданы**, генератор ведёт себя как сейчас **за исключением** безопасной замены «24 нуля → 24 единицы» в guard-хвосте (это изменение сделать дефолтом, т.к. оно не влияет на декодер и только убирает паразитные переходы на конце).

---

## Проверочные критерии (acceptance)

1. **Начало импульса**: на нижнем графике FM в окне ±1.5 мс вокруг «красной» вертикали отсутствуют выбросы > ±600 Гц; кривая монотонно выходит из 0 Гц в преамбулу (0101…), без колец.
2. **Конец импульса**: в последние 2–3 мс перед спадом RMS нет пилообразной активности; FM возвращается к 0 Гц и остаётся там до начала кроссфейда на шум.
3. **CRC**: кадры с тем же payload продолжают декодироваться (CRC-OK). Длина кадра увеличивается лишь на `pre_guard_ones_symbols + post_guard_ones_symbols` символов (нормально).
4. **Воспроизводимость**: при фиксированном `seed` шума форма начала/конца стабильна, без «дрожи».
5. **Совместимость**: ваш парсер и текущая логика измерения длительности импульса не меняются.

---

## Подсказки к реализации (куда править)

* **Секция сборки кадра AIS**: заменить «буфер нулей» на «буфер единиц», добавить guard перед преамбулой.
* **Функция GMSK**: в `_gmsk_modulate_ais(...)` ввести внутренний **символьный паддинг** (единицы), свёртка, обрезка паддинга.
* **Стыки**: в `build_ais(...)` ввод кроссфейдов между `[pre_noise]↔[carrier]` и `[iq]↔[post_noise]`.
* **Параметры**: описанные выше ключи в `standard_params`, значения по умолчанию.


