### ТЗ на переработку проекта под вкладки стандартов, с чисткой «хвостов» прошлой реализации.

# 0) Цели

* Разделить UI на тематические вкладки:
  **Basic (FM/PM/AM), AIS, 406, DSC-VHF, DSC-HF, NAVTEX, 121.5**.
* Перенести всю работу с путями/логами в единый модуль.
* Сохранить рабочий непрерывный CW/loop через HackRF (`-R`) и «жёсткий Stop».
* Удалить/переименовать старые страницы и откровенно лишние файлы.
* Привести профили/каталоги к единому виду внутри пакета `rfgen/`.

---

# 1) Новая структура пакета (папки/модули)

Оставляем пакет `rfgen/` и внутри него:

```
rfgen/
  ui_qt/
    app.py
    main_window.py
    pages/
      page_gen_basic.py     # Раньше page_quick.py (FM/PM/AM + тон/пэттерны)
      page_ais.py
      page_406.py
      page_dsc_vhf.py
      page_dsc_hf.py
      page_navtex.py
      page_121.py
      page_profiles.py       # менеджер профилей
      page_logs.py           # просмотр логов/диагностика
  core/
    tx_chain.py              # сборка конвейера (resample, IF, нормировка, запись)
    mods.py                  # AM/FM/PM/GMSK/BPSK/FSK и т.п.
    pulses.py                # фильтры (Gaussian, RC/RRC…)
    framing.py               # CRC, скремблеры, интерлив, NRZI…
    sources.py               # тон/свип/шум/бит-паттерны
  standards/
    ais.py                   # builder→framer→GMSK mapper
    c406.py                  # builder→framer→BPSK mapper
    dsc_vhf.py               # builder→framer→FSK/MSK mapper
    dsc_hf.py
    navtex.py                # SITOR-B→FSK mapper
  backends/
    hackrf.py                # запуск/стоп с логами (усиленный Stop)
    fileout.py               # запись .sc8
  utils/
    paths.py                 # profiles_dir()/out_dir()/logs_dir()
    migrate.py               # перенос старых profiles из корня
    profile_io.py            # валидация/дефолты профиля, версия схемы
  profiles/                  # JSON (игнорить в git)
  out/                       # IQ-артефакты (игнорить в git)
  logs/                      # логи (игнорить в git)
```

**Удалить/переименовать:**

* Переименовать `page_quick.py` → `page_gen_basic.py`.
* Удалить старые/неиспользуемые страницы (`page_signal_lab.py`, `page_scheduler.py`), если они не нужны в новой фазе.
* Удалить все прямые расчёты путей `parents[3]` — заменить на `utils/paths.py`.
* Удалить/перенести **корневые** папки `C:\work\rfgen\profiles\` и `C:\work\rfgen\out\` (всё должно жить в `rfgen/profiles/`, `rfgen/out/`).
* Проверить и удалить устаревшие модули/батники, которые дублируют запуск.

---

# 2) Единый модуль путей и профилей

## `utils/paths.py`

* `pkg_root() -> Path` → `.../rfgen/`
* `profiles_dir(), out_dir(), logs_dir()` → создают папки при первом обращении.

## `utils/profile_io.py`

* `PROFILE_SCHEMA_VERSION = 1`
* `defaults()` → словарь дефолтов для блоков `device/modulation/pattern/schedule/standard_params`.
* `validate_profile(p: dict) -> (ok: bool, msg: str)`
* `apply_defaults(p: dict) -> dict`
* Вспомогательные функции: `load_json(path)`, `save_json(path, data)`.

## `utils/migrate.py`

* `migrate_legacy_profiles()` → перенос из `<repo_root>/profiles/*.json` в `rfgen/profiles/` (без перезаписей; конфликт → `_migrated`).

---

# 3) UI-вкладки (назначение и поведение)

## A) **page_gen_basic.py** (бывший Quick)

* **Назначение**: непрерывные тестовые сигналы без протокола (CW/AM/FM/PM) + паттерны FF00, F0F0, 3333, 5555, Tone, Sweep, Noise.
* **Поля**: backend, Fs TX, TX Gain, Target, IF offset, Modulation (None/AM/FM/PM), параметры модуляции, Pattern, Tone Hz/Bitrate, Loop (всегда), Duration кадра (по умолчанию 1 s, с опцией «подогнать к целому числу периодов IF»).
* **Кнопки**: Start/Stop/Save Profile/Load Profile.
* **Логика**:

  * Start: формирует 1 s кадр (или N s), пишет `.sc8` в `out_dir()`, если backend=hackrf — запускает `hackrf_transfer -R`, лог в `logs_dir()`.
  * Stop: terminate → wait → kill, логирует шаги, обновляет кнопку/статус.
  * Save/Load: через `profile_io`, папка `profiles_dir()`, диалоги с дефолтным открытием в этой папке.
  * Хинт: при IF=0 и мод=None показывать предупреждение «-inf dBFS в утилите — норма (DC)».
* **Статус**: PID, путь к логу, используемый файл `.sc8`.

## B) **page_ais.py**

* **Назначение**: формирование AIS (GMSK 9600 bps, BT≈0.4), NMEA VDM import, тестовый непрерывный GMSK (PRBS/паттерны).
* **Поля**: Channel A/B или Target вручную, payload (MMSI/тип/поля) ИЛИ выбор файла VDM, BT, repeats/gap/test mode.
* **Логика**:

  * `standards/ais.py`: builder→scrambler→CRC→framer→GMSK mapper.
  * Далее через `core/tx_chain.py` в `.sc8` + HackRF как в Basic.

## C) **page_406.py**

* **Назначение**: COSPAS-SARSAT 406 МГц (BPSK). По умолчанию — fileout/экранированный стенд (юридический хинт).
* **Поля**: Beacon/Hex ID, тип сообщения, FEC/интерлив preset, frame/burst count, test mode (BPSK паттерны).
* **Логика**: `standards/c406.py`: builder→FEC→BPSK mapper → `tx_chain`.

## D) **page_dsc_vhf.py**, **page_dsc_hf.py**

* **Поля**: адресация/категория/поля из ITU-R, скорость, AFSK/FSK/MSK опции, repeats/test mode.
* **Логика**: соответствующие builder→framer→(A)FSK/MSK mapper → `tx_chain`.

## E) **page_navtex.py**

* **Поля**: текст/файл, baud=100, shift=170 Hz, целевая частота, repeats.
* **Логика**: `standards/navtex.py`: SITOR-B encode → FSK mapper → `tx_chain`.

## F) **page_121.py**

* **Поля**: CW/AM tone/sweep, Tone Hz, Depth, Duty, repeats.
* **Логика**: AM-модуляция на несущей → `tx_chain`.

## G) **page_profiles.py**

* **Назначение**: менеджер профилей (список `rfgen/profiles/*.json`, Load/Duplicate/Rename/Delete/Import/Export, превью JSON).
* **Интеграция**: событие `profile_loaded(profile)` — ловят вкладки и заполняют форму.

## H) **page_logs.py**

* **Назначение**: просмотр логов `rfgen/logs/*.log` + диагностика (версии, PATH, наличие хардварных утилит, запущенные процессы).
* **Кнопки**: Tail/Refresh, Open in Explorer, Kill all hackrf_transfer, Clear logs (confirm).

---

# 4) Бэкенды и конвейер

## `backends/hackrf.py`

* Оставить класс `HackRFTx` с: `run_loop(iq_path, fs_tx, center_hz, tx_gain_db)`; `stop(timeout_sec=1.5)`, `is_running()`.
* При старте — писать лог `hackrf_YYYYMMDD_HHMMSS.log`: CMD, PID, IQ путь + весь stdout/err.
* Stop: `terminate()` → ждем → `kill()`; логируем `[stop] …`.

## `backends/fileout.py`

* Запись `.sc8` (интерлив int8 IQ).
* (Опционально) запись `.cf32` для совместимости, но UI использует `.sc8`.

## `core/tx_chain.py`

* Вход: `samples_baseband (complex64)`, `fs`, `if_offset_hz`, `level`, `frame_s`.
* Операции: нормировка уровня; IF-сдвиг (комплексный тон); (опционально) доворот фазы для seamless-loop при IF≠0; выдача массива для записи.

## `core/mods.py` / `pulses.py` / `framing.py` / `sources.py`

* Общие блоки для всех стандартов (без UI).
* Источники: tone/sweep/noise/битовые паттерны.

---

# 5) Профили (JSON)

* Единый формат:

  ```
  {
    "schema": 1,
    "name": "...",
    "standard": "basic" | "ais" | "c406" | "dsc_vhf" | "dsc_hf" | "navtex" | "121",
    "standard_params": {...},         # поля конкретного стандарта
    "modulation": {...},              # для basic; для стандарта может быть зафиксировано
    "pattern": {...},                 # для basic/test-mode
    "schedule": {"mode":"loop","repeat":1,"gap_s":0.0,"duration_s":1.0},
    "device": {"backend":"hackrf","fs_tx":..., "tx_gain_db":...,
               "target_hz":..., "if_offset_hz":..., "freq_corr_hz":...},
    "_meta": {"created_utc":"...", "notes": "..."}
  }
  ```
* `utils/profile_io.py` отвечает за валидацию и дефолты.

---

# 6) Чистка прошлой реализации (обязательно)

* **Удалить**:

  * Старые страницы `page_signal_lab.py`, `page_scheduler.py` (если мы их **осознанно** исключаем сейчас).
  * Прямые обращения к путям через `Path(__file__).resolve().parents[...]`.
  * Все «корневые» папки `profiles/`, `out/` на уровне `C:\work\rfgen\` — оставить только внутри `rfgen/`.
  * Батники, которые запускают Python вне venv/без очистки окружения (оставить один рабочий).
* **Оставить**:

  * Улучшенный Stop в `backends/hackrf.py`.
  * SC8-вывод.
  * Диагностический вывод в логи.
* **.gitignore** (в корне репо) должен содержать:

  ```
  /rfgen/profiles/*.json
  /rfgen/out/*
  /rfgen/logs/*
  /.venv/
  ```

---

# 7) Поведение Start/Stop и статусы

* Start: отключить Start/Save/Load, включить Stop; статус: «PID, center/f_s, log path».
* Stop: всегда задействовать `HackRFTx.stop()`; после — вернуть кнопки; статус: «stopped».
* Перед Start (опция в настройках): «Kill stale hackrf_transfer» (taskkill /IM hackrf_transfer.exe /F).

---

# 8) Приёмочные критерии

* **Навигация**: вкладки Basic/AIS/406/DSC-VHF/DSC-HF/NAVTEX/121/Profiles/Logs отображаются и открываются.
* **Пути**: все артефакты (профили, out, логи) создаются **строго** внутри `rfgen/`.
* **Basic**: Start/Stop стабильно; при IF=0 — уровень в утилите `-inf` (ожидаемо); при IF≠0 — уровень нормальный, тон на `target±IF`.
* **Profiles**: Save/Load работают из `rfgen/profiles/`; миграция отрабатывает, если найдена `/<repo_root>/profiles`.
* **Logs**: появляются `hackrf_*.log`; в них видны CMD, PID, строки `[stop] ... stopped, returncode=...`.
* **Чистка**: нет упоминаний `parents[3]`, нет лишних корневых папок `profiles/` и `out/`.
* **Документация**: короткий README в `docs/` с описанием вкладок и предупреждением о правовом статусе эфира.

---

# 9) Порядок работ (по спринту)

1. Ввести `utils/paths.py`, `profile_io.py`, `migrate.py`; заменить все пути на вызовы из `utils`.
2. Переименовать `page_quick.py` → `page_gen_basic.py`; протянуть Save/Load/Start/Stop/логи.
3. Создать заготовки страниц AIS/406/DSC-VHF/DSC-HF/NAVTEX/121 (UI-скелеты с Save/Load/Start/Stop).
4. Добавить `page_profiles.py` (менеджер профилей) и `page_logs.py` (просмотр логов).
5. Удалить старые страницы и корневые папки `profiles/`, `out/` (после миграции).
6. README в `docs/` + `.gitignore`.
7. Пройти чек-лист приёмки.


