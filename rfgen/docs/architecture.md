# rfgen — Архитектура проекта (Draft v0)

Этот документ описывает каркас универсального RF‑генератора, который строим по этапам. Он отражает договорённости из переписки и служит «дорожной картой» реализации.

---

## 1) Цели и принцип работы

**rfgen** — это кроссплатформенный инструмент для непрерывной генерации RF‑сигналов:
- простые непрерывные сигналы: **Carrier/AM/FM/PM**, тоны, свипы, шум;
- тестовые битовые **паттерны** (FF00h, F0F0h, 3333h, 5555h...) для отладки трактов;
- стандартизованные режимы: **PSK‑406**, **AIS (тестовые шаблоны)**, **DSC VHF**, **DSC HF**, **121.5 AM** (тон/свип).

Генератор формирует IQ‑буферы → подаёт их в **backend** (HackRF или FileOut). Для реального времени backend работает в режиме **loop** или **N‑повторов** с «gap» внутри файла (нулевые сэмплы), сохраняя непрерывность.

---

## 2) Структура каталогов

```
rfgen/
  core/                 # ядро сигналов и планировщик
    wave_engine.py      # сборка волн/модуляций/паттернов в непрерывный поток
    mod_fm.py           # FM
    mod_am.py           # AM (A3E/DSB/SC)
    mod_pm.py           # PM
    shaping.py          # огибающие, плавные фронты, окна
    resample.py         # пересемплирование IQ
    patterns.py         # тест-последовательности (FF00h, F0F0h, 3333h, 5555h…)
    scheduler.py        # циклические сценарии, профили
    meters.py           # RMS/peak/dev/phase
    recording.py        # запись cf32/sc8, экспорт
  standards/            # режимы с протокольной логикой
    psk406.py           # PSK‑406 (hex → биты → IQ)
    ais.py              # AIS тест-паттерны (позже GMSK)
    dsc_vhf.py          # DSC VHF (AFSK/FM)
    dsc_hf.py           # DSC HF (AFSK/SSB)
    am_121p5.py         # 121.5 MHz AM тон/свип
  backends/             # аппаратные выводы
    hackrf.py           # hackrf_transfer loop/повторы, LO/IF, TX gain/PA
    pluto.py            # (резерв) Soapy/pyadi
    fileout.py          # вывод в cf32/sc8
  ui_qt/                # Qt-приложение (PySide6)
    app.py              # точка входа
    main_window.py      # сайдбар + стек страниц
    pages/
      page_quick.py     # быстрый старт (Quick TX)
      page_profiles.py  # профили
      page_signal_lab.py# конструктор сигналов
      page_scheduler.py # расписание
      page_logs.py      # логи/телеметрия
    components/         # общие виджеты/утилиты
  cli/
    rfgen_cli.py        # CLI-интерфейс (быстрые запуски)
  profiles/             # JSON‑профили (пользовательские)
  docs/                 # документация (этот файл, схемы)
  tests/                # тесты (юнит/интеграционные)
```

---

## 3) Логические слои

### 3.1 WaveEngine (core/wave_engine.py)
- Принимает **SignalSpec**, **ModulatorSpec**, **Schedule**.
- Склеивает источники (тон/паттерн/шум/сообщение) и модулятор (**AM/FM/PM**) в **непрерывный IQ‑поток**.
- Поддерживает мягкие стыки (огибающие), контроль уровня и клиппинга.

### 3.2 Модуляция (core/mod_*.py)
- **FM**: девиация (Hz), тон/свип/битовый драйвер.
- **PM**: фазовый индекс (rad), плавные фронты (заимствуем логику PSK‑406).
- **AM**: глубина (0..1), варианты A3E/DSB/SC.

### 3.3 Паттерны (core/patterns.py)
- Бесконечные **битовые циклы**: FF00 / F0F0 / 3333 / 5555 (поля: bitrate_bps).
- **Tone** (частота Hz), **Sweep**, **Noise**, ступеньки девиации (DEV‑steps).

### 3.4 Стандарты (standards/)
- **PSK‑406**: hex → биты → полубиты → плавные фазовые фронты → IQ.
- **AIS**: тест‑паттерны (на первом этапе через FM/PM). Позже — полноценная GMSK.
- **DSC VHF/HF**: на первом этапе — «сетап‑тоны/AFSK» непрерывно; затем кадры сообщения.
- **121.5 AM**: тон/свип, глубина AM.

### 3.5 Backends (аппаратные выводы)
- **HackRF**: режим **loop**/повторы, пересемплинг, цифровой сдвиг IF, управление gain/PA.
- **FileOut**: экспорт cf32/sc8 (для оффлайн‑плея и регресса).
- (Позже) **Pluto/USRP** через общий интерфейс `TxBackend`.

### 3.6 Профили
- **JSON** с «режим + параметры + расписание + устройство».
- Быстрая загрузка из UI (Quick TX, Profiles), экспорт/импорт.

### 3.7 Журнал и метрики
- Логи операций (старт/стоп/ошибки), сохранение параметров кадра.
- Метрики: RMS/peak/девиация (оценка), длительности, битрейт.

---

## 4) Qt‑интерфейс (страницы)

### 4.1 Quick TX
- Device: Backend, Fs TX, Gain, PA.
- Radio: Target/IF offset/Freq corr.
- Modulation: None/FM/PM/AM (+ параметры).
- Pattern: Tone/Sweep/FF00/F0F0/3333/5555/Noise (+ bitrate/tone).
- Schedule: Loop/Repeat/Gap.
- Кнопки: Start/Stop/Save as Profile…

### 4.2 Profiles
- Список JSON‑профилей, просмотр/редактирование, загрузка/запуск.
- Дубликаты, экспорт/импорт.

### 4.3 Signal Lab
- Источник (тон/паттерн/файл/сообщение), модулятор, сборка сегментов без разрывов.
- Preview длительностей/уровней. Кнопка «Generate to File (cf32)».

### 4.4 Scheduler
- Таймлайны и расписания сериальных прогонов.

### 4.5 Logs & Telemetry
- Консоль backend’а, экспорт лога, индикаторы уровня/клиппинга.

---

## 5) Профили — форма и поля (черновик)

```json
{
  "name": "AIS_FF00_FM_cont",
  "standard": "generic",
  "modulation": { "type": "FM", "deviation_hz": 5000 },
  "pattern": { "type": "BITS", "preset": "FF00", "bitrate_bps": 9600 },
  "schedule": { "mode": "loop", "gap_s": 0.0, "repeat": 1 },
  "device": {
    "backend": "hackrf",
    "fs_tx": 2000000,
    "tx_gain_db": 30,
    "pa": true,
    "target_hz": 162025000,
    "if_offset_hz": -25000,
    "freq_corr_hz": 0
  }
}
```
**Примечания:**
- `standard` может быть: `generic`, `psk406`, `ais`, `dsc_vhf`, `dsc_hf`, `am_121p5`.
- Для `psk406` добавятся поля `hex_message`, `front_samples`, `bitrate_bps=400`, параметры фаз.

---

## 6) Состояния TX (FSM)

```
Idle → Preparing (генерация/ресемплинг) → Armed → Transmitting (loop/N) → Stopping → Idle
```
- «Непрерывность» обеспечивается: а) loop одинакового кадра, б) вставкой «gap» (нули) внутрь кадра для N‑повторов.

---

## 7) Совместимость (STRICT_COMPAT)

- Backend HackRF повторяет текущие привычные параметры: **LO/IF**, цифровой сдвиг, `repeat/gap`, поведение `loop`.
- Переиспользуем имеющиеся поля UI (Target/IF/FreqCorr/TxGain/Fs_tx/Repeat/Gap...).
- PSK‑406: перенос логики плавных фронтов; ограничения по `front_samples` сохраняем.

---

## 8) Дорожная карта

1. **UI Quick TX**: форма, сохранение профиля; StatusBar‑нотификации.
2. **Profiles**: список/загрузка/редактирование JSON.
3. **Интерфейсы ядра**: `WaveEngine`, `TxBackend` (HackRF, FileOut), базовые stubs.
4. **Генерация сигналов**: Tone/Noise/Sweep + AM/FM/PM.
5. **Standards**: PSK‑406 (из hex), 121.5 AM; AIS тест‑паттерны.
6. **Scheduler/Telemetry**: длинные прогоны, логи и метрики.

---

## 9) Правила коммитов и репозитория (кратко)

- **STRICT_COMPAT**: не ломать публичные API; новые фичи — флагами.
- Минимальные PR: отдельные страницы/UI‑узлы/модули ядра.
- Привязывать каждый PR к простым smoke‑тестам (открытие UI, сохранение профиля, генерация cf32).

---

**Статус документа:** draft. Обновлять по мере реализации.
